<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SANTINI - Gestión Sincronizada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #070b14; color: #f1f5f9; margin: 0; overflow-x: hidden; }
        .tab-btn.active { border-bottom: 4px solid #3b82f6; color: #3b82f6; }
        input, select { background: #111827; border: 1px solid #1e293b; color: white; padding: 12px; border-radius: 12px; outline: none; }
        .card-pago { background: #ffffff; color: #0f172a; border-radius: 24px; padding: 20px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body>

    <div id="login-screen" class="fixed inset-0 z-50 bg-[#070b14] flex items-center justify-center p-6">
        <div class="bg-[#111827] p-8 w-full max-w-sm text-center border border-slate-800 rounded-3xl">
            <h1 class="text-3xl font-black italic mb-2">SANTINI</h1>
            <p class="text-sky-400 font-bold text-[10px] mb-8 uppercase tracking-widest">Panel de Control</p>
            <div class="space-y-4">
                <input type="email" id="log-email" placeholder="Usuario (Email)" class="w-full text-center">
                <input type="password" id="log-pass" placeholder="Password" class="w-full text-center">
                <button id="btn-ingresar" class="w-full bg-sky-500 text-slate-900 p-4 rounded-xl font-black uppercase">Entrar</button>
            </div>
        </div>
    </div>

    <div id="app-screen" class="hidden min-h-screen flex flex-col">
        <header class="p-4 bg-slate-900 border-b border-slate-800 flex justify-between items-center">
            <div class="italic font-black text-xl">SANTINI</div>
            <button id="btn-salir" class="text-slate-500 text-xl"><i class="fas fa-power-off"></i></button>
        </header>

        <nav class="flex bg-slate-900 border-b border-slate-800 sticky top-0 z-30">
            <button onclick="showTab('tareas')" id="btn-tareas" class="tab-btn active flex-1 p-4 font-black text-[10px] uppercase">Agenda</button>
            <button onclick="showTab('propinas')" id="btn-propinas" class="tab-btn flex-1 p-4 font-black text-[10px] uppercase">Propinas</button>
            <button onclick="showTab('staff')" id="btn-staff" class="tab-btn flex-1 p-4 font-black text-[10px] uppercase">Personal</button>
        </nav>

        <main class="flex-1 p-4 pb-20 overflow-y-auto">
            
            <div id="tab-tareas" class="space-y-4">
                <div class="flex gap-2">
                    <input type="text" id="nueva-tarea" placeholder="Nueva tarea..." class="flex-1 text-sm">
                    <select id="prioridad-tarea" class="text-xs">
                        <option value="baja">Baja</option>
                        <option value="media">Media</option>
                        <option value="alta">Alta</option>
                    </select>
                    <button onclick="agregarTarea()" class="bg-sky-500 text-slate-900 px-4 rounded-xl font-black">+</button>
                </div>
                <div id="lista-tareas" class="space-y-2"></div>
            </div>

            <div id="tab-propinas" class="hidden space-y-4">
                <div class="bg-slate-900 p-4 rounded-2xl border border-slate-800 space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-[9px] font-black text-sky-400 uppercase">F. Propina</label>
                            <input type="date" id="fecha-propina" class="w-full text-xs mt-1">
                        </div>
                        <div>
                            <label class="text-[9px] font-black text-sky-400 uppercase">F. Pago</label>
                            <input type="date" id="fecha-pago" class="w-full text-xs mt-1">
                        </div>
                    </div>
                    <input type="text" id="quien-pago" placeholder="Quién pagó / Concepto" class="w-full text-sm">
                    <input type="number" id="monto-total" placeholder="Monto Recaudado $0.00" oninput="calcular()" class="w-full text-2xl font-black text-sky-400">
                </div>

                <h2 class="text-[10px] font-black uppercase text-slate-500 px-1">Seleccionar Personal y Horas</h2>
                <div id="grid-propinas-staff" class="grid grid-cols-2 gap-2"></div>

                <div id="reporte-visual" class="hidden">
                    <div class="card-pago">
                        <div class="text-center mb-4 border-b border-slate-100 pb-2">
                            <h3 class="font-black italic text-xl uppercase">Resumen de Reparto</h3>
                            <p id="info-pago-txt" class="text-[10px] font-bold text-slate-400 mt-1 uppercase"></p>
                        </div>
                        <div id="tabla-reparto" class="space-y-3"></div>
                        <div class="mt-6 pt-4 border-t border-slate-100 flex justify-between items-center font-black">
                            <span class="text-xs uppercase text-slate-400">Total Distribuido:</span>
                            <span id="total-final" class="text-2xl text-sky-600 font-black"></span>
                        </div>
                        <button onclick="descargarYLimpiar()" class="w-full mt-6 bg-slate-900 text-white p-4 rounded-xl font-black uppercase text-xs">Descargar y Limpiar</button>
                    </div>
                </div>
            </div>

            <div id="tab-staff" class="hidden space-y-4">
                <div class="flex gap-2">
                    <input type="text" id="nuevo-nombre" placeholder="Nombre..." class="flex-1 uppercase font-bold text-sm">
                    <button onclick="agregarStaff()" class="bg-green-600 text-white px-6 rounded-xl font-black">Añadir</button>
                </div>
                <div id="lista-staff-admin" class="space-y-2"></div>
            </div>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB_qivYXUASWoLB3zJcCpUOn44TokzzWro",
            authDomain: "pasaplatos-c9588.firebaseapp.com",
            projectId: "pasaplatos-c9588",
            storageBucket: "pasaplatos-c9588.firebasestorage.app",
            messagingSenderId: "885252229249",
            appId: "1:885252229249:web:2f04b59f0ad8d6c1736580"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let staffGlobal = [];
        let seleccionados = [];

        // AUTH
        document.getElementById('btn-ingresar').onclick = async () => {
            const email = document.getElementById('log-email').value;
            const pass = document.getElementById('log-pass').value;
            try { await signInWithEmailAndPassword(auth, email, pass); } catch (e) { alert("Error de acceso"); }
        };
        document.getElementById('btn-salir').onclick = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                sincronizarDatos();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        });

        // SINCRONIZACIÓN EN TIEMPO REAL CON FIRESTORE
        function sincronizarDatos() {
            // Escuchar Staff
            onSnapshot(query(collection(db, "staff"), orderBy("nombre")), (snap) => {
                staffGlobal = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStaff();
                renderPropinasStaff();
            });

            // Escuchar Tareas
            onSnapshot(query(collection(db, "tareas"), orderBy("creado", "desc")), (snap) => {
                const tareas = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTareas(tareas);
            });
        }

        // ACCIONES FIRESTORE
        window.agregarStaff = async () => {
            const nombre = document.getElementById('nuevo-nombre').value.toUpperCase().trim();
            if(nombre) {
                await addDoc(collection(db, "staff"), { nombre });
                document.getElementById('nuevo-nombre').value = "";
            }
        };

        window.eliminarStaff = async (id) => {
            if(confirm("¿Eliminar empleado?")) await deleteDoc(doc(db, "staff", id));
        };

        window.agregarTarea = async () => {
            const text = document.getElementById('nueva-tarea').value;
            const prio = document.getElementById('prioridad-tarea').value;
            if(text) {
                await addDoc(collection(db, "tareas"), { text, prio, creado: Date.now() });
                document.getElementById('nueva-tarea').value = "";
            }
        };

        window.borrarTarea = async (id) => {
            await deleteDoc(doc(db, "tareas", id));
        };

        // LÓGICA DE PROPINAS (Igual a la anterior pero usa staffGlobal)
        window.toggleSeleccion = (nombre) => {
            const idx = seleccionados.findIndex(x => x.nombre === nombre);
            if(idx > -1) {
                seleccionados.splice(idx, 1);
            } else {
                const h = prompt(`Horas para ${nombre}:`, "8");
                if(h && !isNaN(h)) seleccionados.push({ nombre, horas: parseFloat(h) });
            }
            renderPropinasStaff();
            window.calcular();
        };

        window.calcular = () => {
            const total = parseFloat(document.getElementById('monto-total').value) || 0;
            const reporte = document.getElementById('reporte-visual');
            const tabla = document.getElementById('tabla-reparto');
            
            if(total > 0 && seleccionados.length > 0) {
                reporte.classList.remove('hidden');
                const totalH = seleccionados.reduce((acc, x) => acc + x.horas, 0);
                const valorH = total / totalH;
                document.getElementById('info-pago-txt').innerText = `PAGÓ: ${document.getElementById('quien-pago').value || '---'} | FECHA: ${document.getElementById('fecha-pago').value}`;
                document.getElementById('total-final').innerText = `$ ${total.toLocaleString()}`;
                tabla.innerHTML = "";
                [...seleccionados].sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(e => {
                    const paga = e.horas * valorH;
                    tabla.innerHTML += `<div class="flex justify-between items-center border-b border-slate-100 pb-2">
                        <div><div class="font-black text-slate-800 uppercase text-sm">${e.nombre}</div><div class="text-[9px] text-slate-400 font-bold italic">${e.horas} HS</div></div>
                        <div class="text-lg font-black text-sky-600">$ ${paga.toFixed(2)}</div>
                    </div>`;
                });
            } else { reporte.classList.add('hidden'); }
        };

        // RENDERS
        function renderStaff() {
            const c = document.getElementById('lista-staff-admin');
            c.innerHTML = "";
            staffGlobal.forEach(s => {
                c.innerHTML += `<div class="bg-slate-900 p-3 rounded-xl flex justify-between border border-slate-800">
                    <span class="font-bold uppercase">${s.nombre}</span><button onclick="eliminarStaff('${s.id}')" class="text-rose-500"><i class="fas fa-trash"></i></button>
                </div>`;
            });
        }

        function renderTareas(tareas) {
            const c = document.getElementById('lista-tareas');
            c.innerHTML = "";
            const clr = { alta: 'border-l-rose-500', media: 'border-l-yellow-500', baja: 'border-l-sky-500' };
            tareas.forEach(t => {
                c.innerHTML += `<div class="bg-slate-900 p-4 rounded-xl border-l-4 ${clr[t.prio]} flex justify-between border border-slate-800">
                    <span class="text-sm">${t.text}</span><button onclick="borrarTarea('${t.id}')" class="text-slate-600"><i class="fas fa-check-circle"></i></button>
                </div>`;
            });
        }

        function renderPropinasStaff() {
            const c = document.getElementById('grid-propinas-staff');
            c.innerHTML = "";
            staffGlobal.forEach(s => {
                const sel = seleccionados.find(x => x.nombre === s.nombre);
                c.innerHTML += `<button onclick="toggleSeleccion('${s.nombre}')" class="p-3 rounded-xl border text-left ${sel ? 'bg-sky-500 text-slate-900 border-sky-400 font-black' : 'bg-slate-900 text-slate-500 border-slate-800'}">
                    <div class="text-[8px] uppercase">${s.nombre}</div><div class="text-xs">${sel ? sel.horas + ' HS' : 'AUSENTE'}</div>
                </button>`;
            });
        }

        window.showTab = (tab) => {
            document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('tab-' + tab).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + tab).classList.add('active');
        };

        window.descargarYLimpiar = () => {
            alert("Reporte descargado (simulado). Limpiando selección.");
            seleccionados = [];
            document.getElementById('monto-total').value = "";
            renderPropinasStaff();
            window.calcular();
        };

    </script>
</body>
</html>
